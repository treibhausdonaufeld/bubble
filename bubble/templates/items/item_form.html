{% extends "base.html" %}

{% load i18n %}
{% load static %}

{% block title %}
  {% if object %}
    {% trans "Edit Item" %} - {{ object.name }}
  {% else %}
    {% trans "Add New Item" %}
  {% endif %}
{% endblock title %}
{% block css %}
  {{ block.super }}
  <!-- Select2 CSS -->
  <link href="{% static 'css/vendor/select2.min.css' %}" rel="stylesheet" />
{% endblock css %}

{% block content %}
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <!-- Processing status alert -->
        {% if object and object.processing_status == 1 %}
        <div class="alert alert-info alert-dismissible fade show" role="alert" id="processing-alert">
          <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-3" role="status">
              <span class="visually-hidden">{% trans "Loading..." %}</span>
            </div>
            <div>
              <strong>{% trans "AI Processing in Progress" %}</strong><br />
              <small>{% trans "We're analyzing your images to suggest a title and description. This will appear automatically when ready." %}</small>
            </div>
          </div>
        </div>
        {% elif object and object.processing_status == 3 %}
        <div class="alert alert-warning" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>
          {% trans "Image processing failed. Please fill in the details manually." %}
        </div>
        {% endif %}

        <div class="card">
          <div class="card-header">
            <h3>
              {% if object %}
                {% trans "Edit Item" %} - {{ object.name }}
              {% else %}
                {% trans "Add New Item" %}
              {% endif %}
            </h3>
          </div>
          <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="item-form">
              {% csrf_token %}
              <!-- Multiple Images Upload -->
              <div class="mb-3">
                <!-- Existing Images (for edit mode) - now acts as drop zone -->
                {% if object and object.images.exists %}
                  <div id="drop-zone" class="border border-2 border-dashed rounded p-3 mb-3 existing-images-drop-zone">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="mb-0">{% trans "Current Images" %}</h6>
                      <div class="d-flex align-items-center gap-2">
                        <small class="text-muted">{% trans "Drop new images here or" %}</small>
                        <input type="file"
                               id="id_images"
                               name="images"
                               class="form-control hidden-file-input"
                               accept="image/*"
                               multiple />
                        <button type="button" id="select-files-btn" class="btn btn-outline-primary btn-sm">
                          <i class="fas fa-plus me-1"></i>{% trans "Add" %}
                        </button>
                      </div>
                    </div>
                    <div class="row">
                      {% for image in object.images.all %}
                        <div class="col-md-3 col-sm-6 mb-3">
                          <div class="card shadow-sm">
                            <div class="position-relative">
                              <img src="{% url 'api:image-get-preview-image' image.id %}"
                                   class="card-img-top existing-image"
                                   alt="{{ image.filename }}" />
                              <div class="position-absolute top-0 end-0 p-1">
                                <button type="button"
                                        class="btn btn-sm btn-danger remove-existing-btn"
                                        data-image-id="{{ image.pk }}"
                                        title="{% trans 'Remove image' %}">
                                  <i class="fas fa-times"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% else %}
                  <!-- Compact Drop Zone for new items -->
                  <div id="drop-zone" class="border border-2 border-dashed rounded p-3 text-center mb-3 compact-drop-zone">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted me-3"></i>
                        <div class="text-start">
                          <p class="mb-1 text-muted">
                            <strong>{% trans "Drop your images here" %}</strong> {% trans "or" %}
                          </p>
                          <small class="text-muted">{% trans "JPG, PNG, GIF • Max 10MB each" %}</small>
                        </div>
                      </div>
                      <div>
                        <input type="file"
                               id="id_images"
                               name="images"
                               class="form-control hidden-file-input"
                               accept="image/*"
                               multiple />
                        <button type="button" id="select-files-btn" class="btn btn-outline-primary btn-sm">
                          <i class="fas fa-plus me-1"></i>{% trans "Select Files" %}
                        </button>
                      </div>
                    </div>
                  </div>
                {% endif %}

                <!-- Upload Stats -->
                <div id="upload-stats" class="small text-muted upload-stats mb-2">
                  <span id="file-count">0</span> {% trans "new files selected" %} •
                  <span id="total-size">0</span> MB {% trans "total" %}
                </div>

                <!-- Image Preview Area for new uploads -->
                <div id="image-preview-container" class="preview-container">
                  <div class="row" id="image-preview-grid"></div>
                </div>

                <!-- Fallback for users without JavaScript -->
                <noscript>
                  <div class="alert alert-info">
                    {% trans "JavaScript is disabled. You can still upload images using the file input below." %}
                  </div>
                  <input type="file"
                         name="images"
                         class="form-control"
                         accept="image/*"
                         multiple />
                </noscript>
              </div>
              <!-- Basic Information -->
              <div class="row mb-3">
                <div class="col-md-12">
                  <label for="{{ form.name.id_for_label }}" class="form-label">
                    {{ form.name.label }} *
                    {% if object and object.processing_status == 1 %}
                    <small class="text-muted">({% trans "AI suggestion will appear here" %})</small>
                    {% endif %}
                  </label>
                  {% if object and object.processing_status == 1 %}
                    <input type="text" class="form-control" value="{{ form.name.value|default:'' }}" disabled />
                    {{ form.name.as_hidden }}
                  {% else %}
                    {{ form.name }}
                  {% endif %}
                  {% if form.name.errors %}<div class="text-danger">{{ form.name.errors }}</div>{% endif %}
                  {% if form.name.help_text %}<div class="form-text">{{ form.name.help_text }}</div>{% endif %}
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-12">
                  <label for="{{ form.description.id_for_label }}" class="form-label">
                    {{ form.description.label }} *
                    {% if object and object.processing_status == 1 %}
                    <small class="text-muted">({% trans "AI suggestion will appear here" %})</small>
                    {% endif %}
                  </label>
                  {% if object and object.processing_status == 1 %}
                    <textarea class="form-control" rows="4" disabled>{{ form.description.value|default:'' }}</textarea>
                    {{ form.description.as_hidden }}
                  {% else %}
                    {{ form.description }}
                  {% endif %}
                  {% if form.description.errors %}<div class="text-danger">{{ form.description.errors }}</div>{% endif %}
                  {% if form.description.help_text %}<div class="form-text">{{ form.description.help_text }}</div>{% endif %}
                </div>
              </div>
              <!-- Category and Type -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="{{ form.selected_category.id_for_label }}" class="form-label">{{ form.selected_category.label }}</label>
                  {{ form.selected_category }}
                  {% if form.selected_category.errors %}<div class="text-danger">{{ form.selected_category.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.item_type.id_for_label }}" class="form-label">{{ form.item_type.label }} *</label>
                  {{ form.item_type }}
                  {% if form.item_type.errors %}<div class="text-danger">{{ form.item_type.errors }}</div>{% endif %}
                </div>
              </div>
              <!-- Price -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="{{ form.price.id_for_label }}" class="form-label">{{ form.price.label }}</label>
                  {{ form.price }}
                  {% if form.price.errors %}<div class="text-danger">{{ form.price.errors }}</div>{% endif %}
                  {% if form.price.help_text %}<div class="form-text">{{ form.price.help_text }}</div>{% endif %}
                </div>
              </div>
              <!-- Dynamic Category Fields -->
              {% for field in form %}
                {% if field.name|slice:"7" == "custom_" %}
                  <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label">
                      {{ field.label }}
                      {% if field.field.required %} *{% endif %}
                    </label>
                    {{ field }}
                    {% if field.errors %}<div class="text-danger">{{ field.errors }}</div>{% endif %}
                    {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                  </div>
                {% endif %}
              {% endfor %}
              <!-- Settings -->
              <div class="mb-3">
                <label class="form-label">{% trans "Settings" %}</label>
                <div class="form-check">
                  {{ form.display_contact }}
                  <label class="form-check-label"
                         for="{{ form.display_contact.id_for_label }}">{{ form.display_contact.label }}</label>
                  {% if form.display_contact.help_text %}<div class="form-text">{{ form.display_contact.help_text }}</div>{% endif %}
                </div>
                <div class="form-check">
                  {{ form.active }}
                  <label class="form-check-label" for="{{ form.active.id_for_label }}">{{ form.active.label }}</label>
                </div>
                <!-- Intern-only fields -->
                {% if form.intern %}
                  <div class="form-check">
                    {{ form.intern }}
                    <label class="form-check-label" for="{{ form.intern.id_for_label }}">{{ form.intern.label }}</label>
                    {% if form.intern.help_text %}<div class="form-text">{{ form.intern.help_text }}</div>{% endif %}
                  </div>
                {% endif %}
                {% if form.th_payment %}
                  <div class="form-check">
                    {{ form.th_payment }}
                    <label class="form-check-label" for="{{ form.th_payment.id_for_label }}">{{ form.th_payment.label }}</label>
                    {% if form.th_payment.help_text %}<div class="form-text">{{ form.th_payment.help_text }}</div>{% endif %}
                  </div>
                {% endif %}
              </div>
              <!-- Form Errors -->
              {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
              <!-- Form Actions -->
              <div class="d-flex justify-content-between">
                <a href="{% if object %}{% url 'items:detail' pk=object.pk %}{% else %}{% url 'items-browse:list' content_type=content_type_slug %}{% endif %}"
                   class="btn btn-outline-secondary">{% trans "Cancel" %}</a>
                {% if object and object.processing_status == 1 %}
                  <button type="button" class="btn btn-primary" disabled>
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    {% trans "Processing..." %}
                  </button>
                {% else %}
                  <button type="submit" class="btn btn-primary">
                      {% trans "Save draft" %}
                  </button>
                  <button type="submit" name="publish" class="btn btn-success">
                      {% trans "Publish" %}
                  </button>
                {% endif %}
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- jQuery and Select2 JavaScript (local files) -->
  <script src="{% static 'js/vendor/jquery.min.js' %}"></script>
  <script src="{% static 'js/vendor/select2.min.js' %}"></script>

<script>
    <!-- Auto-refresh processing status script -->
  {% if object and object.processing_status == 1 %}
    $(document).ready(function() {
      const itemId = {{ object.pk|default:0 }};
      if (itemId > 0) {
        const statusCheckInterval = setInterval(async function() {
          try {
            const response = await fetch(`{% url 'items:processing_status' pk=0 %}`.replace('0', itemId));
            const data = await response.json();

            if (data.status === 'success') {
              if (data.is_completed) {
                window.location.reload();
              }
            }
          } catch (error) {
            console.error('Error checking processing status:', error);
          }
        }, 3000); // Check every 3 seconds
      }
    });
  {% endif %}

</script>

  <script>
    $(document).ready(function() {

      console.log('Document ready, jQuery version:', $.fn.jquery);
      console.log('Select2 available:', typeof $.fn.select2 !== 'undefined');

      if (typeof $.fn.select2 === 'undefined') {
        console.error('Select2 not available');
        return;
      }

      // Find all select fields
      console.log('Category fields found:', $('.select2-category').length);
      console.log('Other select fields found:', $('.select2-field').length);

      try {
        // Initialize Select2 for category dropdown with AJAX
        const categoryField = $('.select2-category');

        categoryField.select2({
          placeholder: "{% trans 'Search and select a category...' %}",
          allowClear: true,
          width: '100%',
          theme: 'default',
          ajax: {
            url: "{% url 'api:category-select2' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
              return {
                q: params.term || '', // search term, empty if no search
                page: params.page || 1
              };
            },
            processResults: function (data, params) {
              return {
                results: data.results,
                pagination: {
                  more: data.pagination.more
                }
              };
            },
            cache: true
          },
          minimumInputLength: 0, // Allow loading without search term
          templateResult: function(category) {
            if (category.loading) {
              return category.text;
            }
            return category.text;
          },
          templateSelection: function(category) {
            return category.text || category.category_name;
          }
        });

        // Check if there's an initial value for editing
        {% if object and object.category %}
        const initialCategory = {
          id: '{{ object.category.pk }}',
          text: '{{ object.category.get_hierarchy|escapejs }}'
        };

        // Create and select the initial option
        const initialOption = new Option(initialCategory.text, initialCategory.id, true, true);
        categoryField.append(initialOption);
        categoryField.trigger('change');

        console.log('Set initial category:', initialCategory);
        {% endif %}

        // Initialize Select2 for all other select fields
        $('.select2-field').select2({
          allowClear: false,
          width: '100%',
          theme: 'default'
        });

        console.log('Select2 initialization complete');

        // Show/hide price field based on item type (using jQuery for consistency)
        const itemTypeField = $('#{{ form.item_type.id_for_label }}');
        const priceField = $('#{{ form.price.id_for_label }}');
        const priceContainer = priceField.closest('.col-md-6');

        function togglePriceField() {
          if (itemTypeField.val() === '0') { // Sell
            priceContainer.show();
            priceField.prop('required', true);
          } else { // Give away or Borrow
            priceContainer.hide();
            priceField.prop('required', false);
            priceField.val('');
          }
        }

        // Use Select2 events for the item type field if it's a Select2 field
        itemTypeField.on('change select2:select', togglePriceField);
        togglePriceField(); // Initial call

      } catch (error) {
        console.error('Error initializing Select2:', error);
      }
    }); // End of $(document).ready()
  </script>
  <script>
    // Image upload preview functionality with drag & drop
    document.addEventListener('DOMContentLoaded', function() {
      const imageInput = document.getElementById('id_images');
      const previewContainer = document.getElementById('image-preview-container');
      const previewGrid = document.getElementById('image-preview-grid');
      const dropZone = document.getElementById('drop-zone');
      const selectFilesBtn = document.getElementById('select-files-btn');
      // Initialize selectedFiles globally so it's accessible to all functions
      let selectedFiles = [];

      // File selection button
      if (selectFilesBtn && imageInput) {
        selectFilesBtn.addEventListener('click', function() {
          imageInput.click();
        });
      }

      // Drag and drop functionality
      // Add drag and drop functionality only if dropZone exists
      if (dropZone) {
        dropZone.addEventListener('dragover', function(e) {
          e.preventDefault();
          dropZone.classList.add('drop-zone-active');
        });

        dropZone.addEventListener('dragleave', function(e) {
          e.preventDefault();
          dropZone.classList.remove('drop-zone-active');
        });

        dropZone.addEventListener('drop', function(e) {
          e.preventDefault();
          dropZone.classList.remove('drop-zone-active');

          const files = e.dataTransfer.files;
          handleFileSelection(files);
        });
      }

      // File input change
      if (imageInput) {
        imageInput.addEventListener('change', function(e) {
          handleFileSelection(e.target.files);
        });
      }

      function handleFileSelection(files) {
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

        // Validate file sizes (10MB max per file)
        const maxSize = 10 * 1024 * 1024; // 10MB
        const validFiles = imageFiles.filter(file => {
          if (file.size > maxSize) {
            alert(`{% trans "File" %} "${file.name}" {% trans "is too large. Maximum size is 10MB." %}`);
            return false;
          }
          return true;
        });

        // Limit total number of files (e.g., 20 max)
        const maxFiles = 20;
        if (selectedFiles.length + validFiles.length > maxFiles) {
          alert(`{% trans "Maximum" %} ${maxFiles} {% trans "images allowed." %}`);
          return;
        }

        // Add new files to existing selection
        selectedFiles = [...selectedFiles, ...validFiles];

        // Update file input
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        imageInput.files = dt.files;

        updatePreview();
      }

      function updatePreview() {
        if (selectedFiles && selectedFiles.length > 0 && previewContainer && previewGrid) {
          previewContainer.classList.add('show-container');
          previewGrid.innerHTML = '';

          // Update upload stats
          const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
          const uploadStatsElement = document.getElementById('upload-stats');
          const fileCountElement = document.getElementById('file-count');
          const totalSizeElement = document.getElementById('total-size');

          if (uploadStatsElement) uploadStatsElement.classList.add('show-stats');
          if (fileCountElement) fileCountElement.textContent = selectedFiles.length;
          if (totalSizeElement) totalSizeElement.textContent = (totalSize / 1024 / 1024).toFixed(1);

          selectedFiles.forEach((file, index) => {
            const reader = new FileReader();

            reader.onload = function(e) {
              const col = document.createElement('div');
              col.className = 'col-md-3 col-sm-6 mb-3';
              col.setAttribute('data-file-index', index);

              col.innerHTML = `
                <div class="card shadow-sm image-card">
                  <div class="position-relative">
                    <img src="${e.target.result}" class="card-img-top preview-image" alt="Preview ${index + 1}" />
                    <div class="position-absolute top-0 end-0 p-2">
                      <button type="button" class="btn btn-sm btn-danger remove-preview-btn" data-file-index="${index}" title="{% trans 'Remove image' %}">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body p-2">
                    <small class="text-muted text-truncate d-block">${file.name}</small>
                    <small class="text-muted">${(file.size / 1024 / 1024).toFixed(1)} MB</small>
                  </div>
                </div>
              `;

              previewGrid.appendChild(col);
            };

            reader.readAsDataURL(file);
          });
        } else if (previewContainer) {
          previewContainer.classList.remove('show-container');
          const uploadStatsElement = document.getElementById('upload-stats');
          if (uploadStatsElement) uploadStatsElement.classList.remove('show-stats');
        }
      }

      // Function to remove preview (for new uploads)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-preview-btn') || e.target.closest('.remove-preview-btn')) {
          const btn = e.target.classList.contains('remove-preview-btn') ? e.target : e.target.closest('.remove-preview-btn');
          const fileIndex = parseInt(btn.getAttribute('data-file-index'));

          // Remove from selectedFiles array
          selectedFiles.splice(fileIndex, 1);

          // Update the file input with remaining files
          const dt = new DataTransfer();
          selectedFiles.forEach(file => dt.items.add(file));
          imageInput.files = dt.files;

          // Update preview
          updatePreview();
        }
      });

      // Function to delete existing images (for edit mode)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-existing-btn') || e.target.closest('.remove-existing-btn')) {
          const btn = e.target.classList.contains('remove-existing-btn') ? e.target : e.target.closest('.remove-existing-btn');
          const imageId = btn.getAttribute('data-image-id');

          if (confirm('{% trans "Are you sure you want to delete this image?" %}')) {
            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            fetch(`/items/delete-image/${imageId}/`, {
                method: 'POST',
                headers: {
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                  'Content-Type': 'application/json',
                },
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // Remove the image card from the DOM with animation
                  const imageCard = btn.closest('.col-md-3, .col-sm-6');
                  imageCard.style.transition = 'opacity 0.3s ease';
                  imageCard.style.opacity = '0';
                  setTimeout(() => imageCard.remove(), 300);
                } else {
                  alert('{% trans "Error deleting image: " %}' + (data.error || '{% trans "Unknown error" %}'));
                  // Restore button
                  btn.disabled = false;
                  btn.innerHTML = '<i class="fas fa-times"></i>';
                }
              })
              .catch(error => {
                console.error('Error:', error);
                alert('{% trans "Error deleting image" %}');
                // Restore button
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-times"></i>';
              });
          }
        }
      });

      // Form submission enhancement
      const form = document.querySelector('form');
      if (form) {
        const submitBtn = form.querySelector('button[type="submit"]');
        if (submitBtn) {
          const originalSubmitText = submitBtn.innerHTML;

          form.addEventListener('submit', function(e) {
            if (selectedFiles && selectedFiles.length > 0) {
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{% trans "Uploading..." %}';

              // Re-enable after a timeout as fallback (in case something goes wrong)
              setTimeout(() => {
                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = originalSubmitText;
                }
              }, 30000); // 30 seconds timeout
            }
          });
        }
      }
    }); // End of DOMContentLoaded
  </script>
{% endblock content %}
<!-- Add these CSS styles to your main stylesheet for enhanced appearance -->
<style>
  /* Drag and drop zone styling */
  #drop-zone {
    cursor: pointer;
    user-select: none;
    border-color: #dee2e6;
    transition: all 0.3s ease;
  }

  #drop-zone:hover,
  .drop-zone-active {
    border-color: #007bff !important;
    background-color: #f8f9fa !important;
  }

  /* Compact drop zone for new items */
  .compact-drop-zone {
    background-color: #fafafa;
  }

  /* Existing images drop zone */
  .existing-images-drop-zone {
    background-color: #f8f9fa;
  }

  .existing-images-drop-zone:hover {
    background-color: #e9ecef !important;
  }

  /* Existing image styling */
  .existing-image {
    height: 120px;
    object-fit: cover;
  }

  /* File input styling */
  .hidden-file-input {
    display: none;
  }

  /* Upload icon styling */
  .upload-icon {
    opacity: 0.5;
  }

  /* Upload stats styling */
  .upload-stats {
    display: none;
  }

  .upload-stats.show-stats {
    display: block;
  }

  /* Preview container styling */
  .preview-container {
    display: none;
  }

  .preview-container.show-container {
    display: block;
  }

  /* Preview image styling */
  .preview-image {
    height: 120px;
    object-fit: cover;
  }

  /* Image preview and management */
  .image-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .image-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
  }

  /* Remove button styling */
  .btn-danger.btn-sm {
    width: 28px;
    height: 28px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 0.75rem;
  }

  /* Small add button styling */
  .btn-outline-primary.btn-sm {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
  }

  /* Tag list scroll styling */
  .tag-list-scroll {
    max-height: 200px;
    overflow-y: auto;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .col-md-3.col-sm-6 {
      flex: 0 0 50%;
      max-width: 50%;
    }

    .existing-image,
    .preview-image {
      height: 100px;
    }
  }
</style>
<!-- Reminder: For production, move the above CSS to your main stylesheet -->
