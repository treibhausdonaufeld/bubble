{% extends "base.html" %}

{% load i18n %}
{% load static %}

{% block title %}
  {% if object %}
    {% trans "Edit Item" %} - {{ object.pk }}
  {% else %}
    {% trans "Add New Item" %}
  {% endif %}
{% endblock title %}
{% block css %}
  {{ block.super }}
  <!-- Select2 CSS -->
  <link href="{% static 'css/vendor/select2.min.css' %}" rel="stylesheet" />
{% endblock css %}

{% block content %}
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-8">
        <!-- Processing status alert -->
        {% if object and object.processing_status == 1 %}
        <div class="alert alert-info alert-dismissible fade show" role="alert" id="processing-alert">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <div class="spinner-border spinner-border-sm me-3" role="status">
                <span class="visually-hidden">{% trans "Loading..." %}</span>
              </div>
              <div>
                <strong>{% trans "AI Processing in Progress" %}</strong><br />
                <small>{% trans "We're analyzing your images to suggest a title and description. This will appear automatically when ready." %}</small>
              </div>
            </div>
            <div class="ms-3">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="cancel-processing-btn" onclick="cancelProcessing()">
                <i class="fas fa-times me-1"></i>
                {% trans "Cancel" %}
              </button>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h3 class="mb-0">
                {% if object %}
                  {% trans "Edit Item" %} - {{ object.pk }}
                {% else %}
                  {% trans "Add New Item" %}
                {% endif %}
              </h3>

              <!-- AI Processing Menu (for completed processing) -->
              {% if object and object.processing_status == 2 %}
              <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="aiActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-robot me-1"></i>
                  {% trans "AI Actions" %}
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="aiActionsDropdown">
                  <li>
                    <button class="dropdown-item" type="button" id="retrigger-processing-btn" onclick="retriggerProcessing()">
                      <i class="fas fa-redo me-2"></i>
                      {% trans "Run AI Processing Again" %}
                    </button>
                  </li>
                </ul>
              </div>
              {% endif %}
            </div>
          </div>
          <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="item-form">
              {% csrf_token %}
              <!-- Multiple Images Upload -->
              <div class="mb-3">
                <!-- Existing Images (for edit mode) - now acts as drop zone -->
                {% if object and object.images.exists %}
                  <div id="drop-zone" class="border border-2 border-dashed rounded p-3 mb-3 existing-images-drop-zone">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="mb-0">{% trans "Current Images" %}</h6>
                    </div>
                    <div class="row">
                      {% for image in object.images.all %}
                        <div class="col-md-3 col-sm-6 mb-3">
                          <div class="card shadow-sm">
                            <div class="position-relative">
                              <img src="{% url 'api:image-get-preview-image' image.id %}"
                                   class="card-img-top existing-image"
                                   alt="{{ image.filename }}" />
                              <div class="position-absolute top-0 end-0 p-1">
                                <button type="button"
                                        class="btn btn-sm btn-danger remove-existing-btn"
                                        data-image-id="{{ image.pk }}"
                                        title="{% trans 'Remove image' %}">
                                  <i class="fas fa-times"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% else %}
                  <!-- Compact Drop Zone for new items -->
                  <div id="drop-zone" class="border border-2 border-dashed rounded p-3 text-center mb-3 compact-drop-zone">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-cloud-upload-alt fa-2x text-muted me-3"></i>
                        <div class="text-start">
                          <p class="mb-1 text-muted">
                            <strong>{% trans "Drop your images here" %}</strong> {% trans "or" %}
                          </p>
                          <small class="text-muted">{% trans "JPG, PNG, GIF • Max 10MB each" %}</small>
                        </div>
                      </div>
                      <div>
                        <input type="file"
                               id="id_images"
                               name="images"
                               class="form-control hidden-file-input"
                               accept="image/*"
                               multiple />
                        <button type="button" id="select-files-btn" class="btn btn-outline-primary btn-sm">
                          <i class="fas fa-plus me-1"></i>{% trans "Select Files" %}
                        </button>
                      </div>
                    </div>
                  </div>
                {% endif %}

                <!-- Upload Stats -->
                <div id="upload-stats" class="d-flex justify-content-between align-items-center upload-stats mb-2">
                  <div class="small text-muted">
                  <span id="file-count">0</span> {% trans "new files selected" %} •
                  <span id="total-size">0</span> {% trans "MB total" %}
                  </div>
                  <div class="d-flex gap-2">
                  <input type="file"
                       id="id_images"
                       name="images"
                       class="hidden-file-input"
                       accept="image/*"
                       multiple />
                  <button type="button" id="select-files-btn" class="btn btn-outline-primary btn-sm" title="{% trans "Select new images" %}">
                    <i class="fas fa-plus"></i>
                  </button>
                  <button type="button" id="upload-new-images-btn" class="btn btn-primary btn-sm" disabled="true">
                    <i class="fas fa-upload me-1"></i>
                  </button>
                  </div>
                </div>

                <!-- Image Preview Area for new uploads -->
                <div id="image-preview-container" class="preview-container">
                  <div class="row" id="image-preview-grid"></div>
                </div>

                <!-- Fallback for users without JavaScript -->
                <noscript>
                  <div class="alert alert-info">
                    {% trans "JavaScript is disabled. You can still upload images using the file input below." %}
                  </div>
                  <input type="file"
                         name="images"
                         class="form-control"
                         accept="image/*"
                         multiple />
                </noscript>
              </div>
              <!-- Basic Information -->
              <div class="row mb-3">
                <div class="col-md-12">
                  <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">
                    {{ form.name.label }} *
                    {% if object and object.processing_status == 1 %}
                    <small class="text-muted">({% trans "AI suggestion will appear here" %})</small>
                    {% endif %}
                  </label>
                  {% if object and object.processing_status == 1 %}
                    <input type="text" class="form-control" value="{{ form.name.value|default:'' }}" disabled />
                    {{ form.name.as_hidden }}
                  {% else %}
                    {{ form.name }}
                  {% endif %}
                  {% if form.name.errors %}<div class="text-danger">{{ form.name.errors }}</div>{% endif %}
                  {% if form.name.help_text %}<div class="form-text">{{ form.name.help_text }}</div>{% endif %}
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-12">
                  <label for="{{ form.description.id_for_label }}" class="form-label fw-bold">
                    {{ form.description.label }} *
                    {% if object and object.processing_status == 1 %}
                    <small class="text-muted">({% trans "AI suggestion will appear here" %})</small>
                    {% endif %}
                  </label>
                  {% if object and object.processing_status == 1 %}
                    <textarea class="form-control" rows="4" disabled>{{ form.description.value|default:'' }}</textarea>
                    {{ form.description.as_hidden }}
                  {% else %}
                    {{ form.description }}
                  {% endif %}
                  {% if form.description.errors %}<div class="text-danger">{{ form.description.errors }}</div>{% endif %}
                  {% if form.description.help_text %}<div class="form-text">{{ form.description.help_text }}</div>{% endif %}
                </div>
              </div>
              <!-- Category and Type -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="{{ form.selected_category.id_for_label }}" class="form-label fw-bold">{{ form.selected_category.label }}</label>
                  {{ form.selected_category }}
                  {% if form.selected_category.errors %}<div class="text-danger">{{ form.selected_category.errors }}</div>{% endif %}
                </div>
                <div class="col-md-6">
                  <label for="{{ form.item_type.id_for_label }}" class="form-label fw-bold">{{ form.item_type.label }} *</label>
                  {{ form.item_type }}
                  {% if form.item_type.errors %}<div class="text-danger">{{ form.item_type.errors }}</div>{% endif %}
                </div>
              </div>
              <!-- Price -->
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="{{ form.price.id_for_label }}" class="form-label fw-bold">{{ form.price.label }}</label>
                  {{ form.price }}
                  {% if form.price.errors %}<div class="text-danger">{{ form.price.errors }}</div>{% endif %}
                  {% if form.price.help_text %}<div class="form-text">{{ form.price.help_text }}</div>{% endif %}
                </div>
              </div>
              <!-- Dynamic Category Fields -->
              {% for field in form %}
                {% if field.name|slice:"7" == "custom_" %}
                  <div class="mb-3">
                    <label for="{{ field.id_for_label }}" class="form-label fw-bold">
                      {{ field.label }}
                      {% if field.field.required %} *{% endif %}
                    </label>
                    {{ field }}
                    {% if field.errors %}<div class="text-danger">{{ field.errors }}</div>{% endif %}
                    {% if field.help_text %}<div class="form-text">{{ field.help_text }}</div>{% endif %}
                  </div>
                {% endif %}
              {% endfor %}
              <!-- Settings -->
              <div class="mb-3">
                <label class="form-label fw-bold">{% trans "Settings" %}</label>
                <div class="form-check">
                  {{ form.display_contact }}
                  <label class="form-check-label"
                         for="{{ form.display_contact.id_for_label }}">{{ form.display_contact.label }}</label>
                  {% if form.display_contact.help_text %}<div class="form-text">{{ form.display_contact.help_text }}</div>{% endif %}
                </div>
                <div class="form-check">
                  {{ form.active }}
                  <label class="form-check-label" for="{{ form.active.id_for_label }}">{{ form.active.label }}</label>
                </div>
                <!-- Intern-only fields -->
                {% if form.internal %}
                  <div class="form-check">
                    {{ form.internal }}
                    <label class="form-check-label" for="{{ form.internal.id_for_label }}">{{ form.internal.label }}</label>
                    {% if form.internal.help_text %}<div class="form-text">{{ form.internal.help_text }}</div>{% endif %}
                  </div>
                {% endif %}
                {% if form.payment_enabled %}
                  <div class="form-check">
                    {{ form.payment_enabled }}
                    <label class="form-check-label" for="{{ form.payment_enabled.id_for_label }}">{{ form.payment_enabled.label }}</label>
                    {% if form.payment_enabled.help_text %}<div class="form-text">{{ form.payment_enabled.help_text }}</div>{% endif %}
                  </div>
                {% endif %}
              </div>
              <!-- Form Errors -->
              {% if form.non_field_errors %}<div class="alert alert-danger">{{ form.non_field_errors }}</div>{% endif %}
              <!-- Form Actions -->
              <div class="d-flex justify-content-between">
                <a href="{% if object %}{% url 'items:detail' pk=object.pk %}{% else %}{% url 'items-category:list' content_type=content_type_slug %}{% endif %}"
                   class="btn btn-outline-secondary">{% trans "Cancel" %}</a>
                {% if object and object.processing_status == 1 %}
                  <button type="button" class="btn btn-primary" disabled>
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    {% trans "Processing..." %}
                  </button>
                {% else %}
                  <button type="submit" class="btn btn-primary">
                      {% trans "Save draft" %}
                  </button>
                  <button type="submit" name="publish" class="btn btn-success">
                      {% trans "Publish" %}
                  </button>
                {% endif %}
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Modals -->
  <!-- Confirmation Modal -->
  <div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmationModalLabel">{% trans "Confirm Action" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmationModalBody">
          <!-- Dynamic content will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
          <button type="button" class="btn btn-primary" id="confirmationModalConfirm">{% trans "Confirm" %}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="alertModalLabel">{% trans "Information" %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="alertModalBody">
          <!-- Dynamic content will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">{% trans "OK" %}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="errorModalLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>{% trans "Error" %}
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="errorModalBody">
          <!-- Dynamic content will be inserted here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">{% trans "OK" %}</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery and Select2 JavaScript (local files) -->
  <script src="{% static 'js/vendor/jquery.min.js' %}"></script>
  <script src="{% static 'js/vendor/select2.min.js' %}"></script>

  <script src="{% static 'js/vendor/select2.min.js' %}"></script>

<script>
  // Modal utility functions
  function showConfirmModal(title, message, onConfirm) {
    document.getElementById('confirmationModalLabel').textContent = title;
    document.getElementById('confirmationModalBody').innerHTML = message;

    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    const confirmBtn = document.getElementById('confirmationModalConfirm');

    // Remove any existing event listeners
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

    // Add new event listener
    newConfirmBtn.addEventListener('click', function() {
      modal.hide();
      onConfirm();
    });

    modal.show();
  }

  function showAlertModal(title, message) {
    document.getElementById('alertModalLabel').textContent = title;
    document.getElementById('alertModalBody').innerHTML = message;

    const modal = new bootstrap.Modal(document.getElementById('alertModal'));
    modal.show();
  }

  function showErrorModal(message) {
    document.getElementById('errorModalBody').innerHTML = message;

    const modal = new bootstrap.Modal(document.getElementById('errorModal'));
    modal.show();
  }

  // Function to cancel AI processing
  function cancelProcessing() {
    const itemId = {{ object.pk|default:0 }};
    if (itemId <= 0) {
      showErrorModal('{% trans "Item ID not found" %}');
      return;
    }

    showConfirmModal(
      '{% trans "Cancel AI Processing" %}',
      '{% trans "Are you sure you want to cancel the AI processing? You can still edit the item manually." %}',
      function() {
        // Disable the cancel button and show loading
        const cancelBtn = document.getElementById('cancel-processing-btn');
        const originalText = cancelBtn.innerHTML;
        cancelBtn.disabled = true;
        cancelBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{% trans "Cancelling..." %}';

        // Send cancel request
        fetch(`{% url 'items:cancel_processing' pk=0 %}`.replace('0', itemId), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Hide the processing alert
            const processingAlert = document.getElementById('processing-alert');
            if (processingAlert) {
              processingAlert.style.display = 'none';
            }

            // If processing status is COMPLETED, show the completed alert
            if (data.processing_status === 2) { // ProcessingStatus.COMPLETED
              const completedAlert = document.getElementById('completed-alert');
              if (completedAlert) {
                completedAlert.style.display = 'block';
              }
            }

            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
              <i class="fas fa-check-circle me-2"></i>
              ${data.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Insert the success message before the card
            const card = document.querySelector('.card');
            card.parentNode.insertBefore(alertDiv, card);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
              if (alertDiv.parentNode) {
                alertDiv.remove();
              }
            }, 5000);
          } else {
            showErrorModal('{% trans "Error:" %} ' + data.message);
            // Re-enable the button
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = originalText;
          }
        })
        .catch(error => {
          console.error('Error cancelling processing:', error);
          showErrorModal('{% trans "An error occurred while cancelling processing. Please try again." %}');
          // Re-enable the button
          cancelBtn.disabled = false;
          cancelBtn.innerHTML = originalText;
        });
      }
    );
  }

  // Function to retrigger AI processing
  function retriggerProcessing() {
    const itemId = {{ object.pk|default:0 }};
    if (itemId <= 0) {
      showErrorModal('{% trans "Item ID not found" %}');
      return;
    }

    showConfirmModal(
      '{% trans "Run AI Processing Again" %}',
      '{% trans "Are you sure you want to run AI processing again? This will overwrite any manual changes to the title and description." %}',
      function() {
        // Disable the retrigger button and show loading
        const retriggerBtn = document.getElementById('retrigger-processing-btn');
        const originalText = retriggerBtn.innerHTML;
        retriggerBtn.disabled = true;
        retriggerBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{% trans "Starting..." %}';

        // Send retrigger request
        fetch(`{% url 'items:retrigger_processing' pk=0 %}`.replace('0', itemId), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          },
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            // Hide the completed alert and AI actions dropdown
            const completedAlert = document.getElementById('completed-alert');
            if (completedAlert) {
              completedAlert.style.display = 'none';
            }

            const aiActionsDropdown = document.getElementById('aiActionsDropdown');
            if (aiActionsDropdown) {
              aiActionsDropdown.closest('.dropdown').style.display = 'none';
            }

            // Show the processing alert
            const processingAlert = document.getElementById('processing-alert');
            if (processingAlert) {
              processingAlert.style.display = 'block';
            }

            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
              <i class="fas fa-check-circle me-2"></i>
              ${data.message}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // Insert the success message before the card
            const card = document.querySelector('.card');
            card.parentNode.insertBefore(alertDiv, card);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
              if (alertDiv.parentNode) {
                alertDiv.remove();
              }
            }, 5000);

            // Reload the page to show the updated processing state
            setTimeout(() => {
              location.reload();
            }, 2000);
          } else {
            showErrorModal('{% trans "Error:" %} ' + data.message);
            // Re-enable the button
            retriggerBtn.disabled = false;
            retriggerBtn.innerHTML = originalText;
          }
        })
        .catch(error => {
          console.error('Error retriggering processing:', error);
          showErrorModal('{% trans "An error occurred while starting AI processing. Please try again." %}');
          // Re-enable the button
          retriggerBtn.disabled = false;
          retriggerBtn.innerHTML = originalText;
        });
      }
    );
  }
</script>

  <script>
    <!-- Auto-refresh processing status script -->
  {% if object and object.processing_status == 1 %}
    $(document).ready(function() {
      const itemId = {{ object.pk|default:0 }};
      if (itemId > 0) {
        const statusCheckInterval = setInterval(async function() {
          try {
            const response = await fetch(`{% url 'items:processing_status' pk=0 %}`.replace('0', itemId));
            const data = await response.json();

            if (data.status === 'success') {
              if (data.is_completed) {
                window.location.reload();
              }
            }
          } catch (error) {
            console.error('Error checking processing status:', error);
          }
        }, 3000); // Check every 3 seconds
      }
    });
  {% endif %}

</script>

  <script>
    $(document).ready(function() {

      console.log('Document ready, jQuery version:', $.fn.jquery);
      console.log('Select2 available:', typeof $.fn.select2 !== 'undefined');

      if (typeof $.fn.select2 === 'undefined') {
        console.error('Select2 not available');
        return;
      }

      // Find all select fields
      console.log('Category fields found:', $('.select2-category').length);
      console.log('Other select fields found:', $('.select2-field').length);

      try {
        // Initialize Select2 for category dropdown with AJAX
        const categoryField = $('.select2-category');

        categoryField.select2({
          placeholder: "{% trans 'Search and select a category...' %}",
          allowClear: true,
          width: '100%',
          theme: 'default',
          ajax: {
            url: "{% url 'api:category-select2' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
              return {
                q: params.term || '', // search term, empty if no search
                page: params.page || 1
              };
            },
            processResults: function (data, params) {
              return {
                results: data.results,
                pagination: {
                  more: data.pagination.more
                }
              };
            },
            cache: true
          },
          minimumInputLength: 0, // Allow loading without search term
          templateResult: function(category) {
            if (category.loading) {
              return category.text;
            }
            return category.text;
          },
          templateSelection: function(category) {
            return category.text || category.category_name;
          }
        });

        // Check if there's an initial value for editing
        {% if object and object.category %}
        const initialCategory = {
          id: '{{ object.category.pk }}',
          text: '{{ object.category.get_hierarchy|escapejs }}'
        };

        // Create and select the initial option
        const initialOption = new Option(initialCategory.text, initialCategory.id, true, true);
        categoryField.append(initialOption);
        categoryField.trigger('change');

        console.log('Set initial category:', initialCategory);
        {% endif %}

        // Initialize Select2 for all other select fields
        $('.select2-field').select2({
          allowClear: false,
          width: '100%',
          theme: 'default'
        });

        console.log('Select2 initialization complete');

        // Show/hide price field based on item type (using jQuery for consistency)
        const itemTypeField = $('#{{ form.item_type.id_for_label }}');
        const priceField = $('#{{ form.price.id_for_label }}');
        const priceContainer = priceField.closest('.col-md-6');

        function togglePriceField() {
          if (itemTypeField.val() === '0') { // Sell
            priceContainer.show();
            priceField.prop('required', true);
          } else { // Give away or Borrow
            priceContainer.hide();
            priceField.prop('required', false);
            priceField.val('');
          }
        }

        // Use Select2 events for the item type field if it's a Select2 field
        itemTypeField.on('change select2:select', togglePriceField);
        togglePriceField(); // Initial call

      } catch (error) {
        console.error('Error initializing Select2:', error);
      }
    }); // End of $(document).ready()
  </script>
  <script>
    // Image upload preview functionality with drag & drop
    document.addEventListener('DOMContentLoaded', function() {
      const imageInput = document.getElementById('id_images');
      const previewContainer = document.getElementById('image-preview-container');
      const previewGrid = document.getElementById('image-preview-grid');
      const dropZone = document.getElementById('drop-zone');
      const selectFilesBtn = document.getElementById('select-files-btn');
      // Initialize selectedFiles globally so it's accessible to all functions
      let selectedFiles = [];

      // Handle upload new images button functionality
      const uploadBtn = document.getElementById('upload-new-images-btn');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
          if (selectedFiles && selectedFiles.length > 0) {
            const form = document.getElementById('item-form');
            if (form) {
              // Show loading state
              const originalText = uploadBtn.innerHTML;
              uploadBtn.disabled = true;
              uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{% trans "Uploading..." %}';

              // Add a hidden input to indicate this is an image upload action
              const uploadInput = document.createElement('input');
              uploadInput.type = 'hidden';
              uploadInput.name = 'action';
              uploadInput.value = 'upload_images';
              form.appendChild(uploadInput);

              // Submit the form
              form.submit();
            }
          }
        });
      }

      // File selection button
      if (selectFilesBtn && imageInput) {
        selectFilesBtn.addEventListener('click', function() {
          imageInput.click();
        });
      }

      // Drag and drop functionality
      // Add drag and drop functionality only if dropZone exists
      if (dropZone) {
        dropZone.addEventListener('dragover', function(e) {
          e.preventDefault();
          dropZone.classList.add('drop-zone-active');
        });

        dropZone.addEventListener('dragleave', function(e) {
          e.preventDefault();
          dropZone.classList.remove('drop-zone-active');
        });

        dropZone.addEventListener('drop', function(e) {
          e.preventDefault();
          dropZone.classList.remove('drop-zone-active');

          const files = e.dataTransfer.files;
          handleFileSelection(files);
        });
      }

      // File input change
      if (imageInput) {
        imageInput.addEventListener('change', function(e) {
          handleFileSelection(e.target.files);
        });
      }

      function handleFileSelection(files) {
        const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));

        // Validate file sizes (10MB max per file)
        const maxSize = 10 * 1024 * 1024; // 10MB
        const validFiles = imageFiles.filter(file => {
          if (file.size > maxSize) {
            showErrorModal(`{% trans "File" %} "${file.name}" {% trans "is too large. Maximum size is 10MB." %}`);
            return false;
          }
          return true;
        });

        // Limit total number of files (e.g., 20 max)
        const maxFiles = 20;
        if (selectedFiles.length + validFiles.length > maxFiles) {
          showErrorModal(`{% trans "Maximum" %} ${maxFiles} {% trans "images allowed." %}`);
          return;
        }

        // Add new files to existing selection
        selectedFiles = [...selectedFiles, ...validFiles];

        // Update file input
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        imageInput.files = dt.files;

        updatePreview();
      }

      function updatePreview() {
        const uploadStatsElement = document.getElementById('upload-stats');

        if (selectedFiles && selectedFiles.length > 0 && previewContainer && previewGrid) {
          previewContainer.classList.add('show-container');
          previewGrid.innerHTML = '';
          uploadBtn.disabled = false;

          // Update upload stats
          const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
          const fileCountElement = document.getElementById('file-count');
          const totalSizeElement = document.getElementById('total-size');

          if (uploadStatsElement) uploadStatsElement.classList.add('show-stats');
          if (fileCountElement) fileCountElement.textContent = selectedFiles.length;
          if (totalSizeElement) totalSizeElement.textContent = (totalSize / 1024 / 1024).toFixed(1);

          selectedFiles.forEach((file, index) => {
            const reader = new FileReader();

            reader.onload = function(e) {
              const col = document.createElement('div');
              col.className = 'col-md-3 col-sm-6 mb-3';
              col.setAttribute('data-file-index', index);

              col.innerHTML = `
                <div class="card shadow-sm image-card">
                  <div class="position-relative">
                    <img src="${e.target.result}" class="card-img-top preview-image" alt="Preview ${index + 1}" />
                    <div class="position-absolute top-0 end-0 p-2">
                      <button type="button" class="btn btn-sm btn-danger remove-preview-btn" data-file-index="${index}" title="{% trans 'Remove image' %}">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body p-2">
                    <small class="text-muted text-truncate d-block">${file.name}</small>
                    <small class="text-muted">${(file.size / 1024 / 1024).toFixed(1)} {% trans "MB" %}</small>
                  </div>
                </div>
              `;

              previewGrid.appendChild(col);
            };

            reader.readAsDataURL(file);
          });
        } else if (previewContainer) {
          previewContainer.classList.remove('show-container');
          uploadBtn.disabled = true;
          if (uploadStatsElement) uploadStatsElement.classList.remove('show-stats');
        }
      }

      // Function to remove preview (for new uploads)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-preview-btn') || e.target.closest('.remove-preview-btn')) {
          const btn = e.target.classList.contains('remove-preview-btn') ? e.target : e.target.closest('.remove-preview-btn');
          const fileIndex = parseInt(btn.getAttribute('data-file-index'));

          // Remove from selectedFiles array
          selectedFiles.splice(fileIndex, 1);

          // Update the file input with remaining files
          const dt = new DataTransfer();
          selectedFiles.forEach(file => dt.items.add(file));
          imageInput.files = dt.files;

          // Update preview (this will reassign correct indices)
          updatePreview();
        }
      });

      // Function to delete existing images (for edit mode)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-existing-btn') || e.target.closest('.remove-existing-btn')) {
          const btn = e.target.classList.contains('remove-existing-btn') ? e.target : e.target.closest('.remove-existing-btn');
          const imageId = btn.getAttribute('data-image-id');

          showConfirmModal(
            '{% trans "Delete Image" %}',
            '{% trans "Are you sure you want to delete this image?" %}',
            function() {
              // Show loading state
              btn.disabled = true;
              btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

              fetch(`/items/delete-image/${imageId}/`, {
                  method: 'POST',
                  headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                  },
                })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    // Remove the image card from the DOM with animation
                    const imageCard = btn.closest('.col-md-3, .col-sm-6');
                    imageCard.style.transition = 'opacity 0.3s ease';
                    imageCard.style.opacity = '0';
                    setTimeout(() => imageCard.remove(), 300);
                  } else {
                    showErrorModal('{% trans "Error deleting image: " %}' + (data.error || '{% trans "Unknown error" %}'));
                    // Restore button
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-times"></i>';
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  showErrorModal('{% trans "Error deleting image" %}');
                  // Restore button
                  btn.disabled = false;
                  btn.innerHTML = '<i class="fas fa-times"></i>';
                });
            }
          );
        }
      });

      // Form submission enhancement
      const form = document.querySelector('form');
      if (form) {
        const submitBtn = form.querySelector('button[type="submit"]');

        if (submitBtn) {
          const originalSubmitText = submitBtn.innerHTML;

          form.addEventListener('submit', function(e) {
            if (selectedFiles && selectedFiles.length > 0) {
              submitBtn.disabled = true;
              submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{% trans "Uploading..." %}';

              // Re-enable after a timeout as fallback (in case something goes wrong)
              setTimeout(() => {
                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.innerHTML = originalSubmitText;
                }
              }, 30000); // 30 seconds timeout
            }
          });
        }
      }
    }); // End of DOMContentLoaded
  </script>
{% endblock content %}
