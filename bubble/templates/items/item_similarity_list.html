{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "AI Search Results" %}{% endblock %}

{% block css %}
{{ block.super }}
<style>
.similarity-search-container {
    max-width: 1200px;
    margin: 0 auto;
}

.search-form {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.search-input {
    border-radius: 50px;
    border: none;
    padding: 1rem 1.5rem;
    font-size: 1.1rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.search-btn {
    border-radius: 50px;
    padding: 1rem 2rem;
    font-weight: 600;
    background: #28a745;
    border: none;
    box-shadow: 0 2px 10px rgba(40, 167, 69, 0.3);
    transition: all 0.3s ease;
}

.search-btn:hover {
    background: #218838;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
}

.example-text {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    border-left: 4px solid #28a745;
}

.results-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 2rem;
}

.ai-icon {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    color: white;
    padding: 1rem;
    border-radius: 50%;
    font-size: 1.5rem;
}

.distance-badge {
    background: rgba(0, 123, 255, 0.1);
    color: #007bff;
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    margin-top: 0.5rem;
    display: inline-block;
}

.no-results {
    text-align: center;
    padding: 3rem;
    background: #f8f9fa;
    border-radius: 12px;
    margin: 2rem 0;
}

.no-results i {
    color: #6c757d;
    margin-bottom: 1rem;
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: #6c757d;
    text-decoration: none;
    margin-top: 2rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.back-link:hover {
    background: #f8f9fa;
    color: #007bff;
    text-decoration: none;
}
</style>
{% endblock %}

{% block content %}
<div class="container similarity-search-container">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="mb-4">
                <h1 class="display-5 fw-bold">
                    <i class="fas fa-brain text-primary me-3"></i>
                    {% trans "AI-Powered Search" %}
                </h1>
                <p class="lead text-muted">
                    {% trans "Describe what you're looking for in natural language. Our AI will find the most similar items." %}
                </p>
            </div>

            <!-- Search Form -->
            <div class="search-form">
                <form method="get">
                    <div class="row g-3 align-items-end">
                        <div class="col-lg-8">
                            <label for="search-input" class="form-label fw-bold">
                                <i class="fas fa-search me-2"></i>
                                {% trans "What are you looking for?" %}
                            </label>
                            <input type="text"
                                   id="search-input"
                                   name="q"
                                   class="form-control search-input"
                                   placeholder="{% trans 'e.g., Gaming laptop with good graphics for video editing' %}"
                                   value="{{ search_query }}"
                                   required>
                        </div>
                        <div class="col-lg-4">
                            <button class="btn search-btn w-100" type="submit">
                                <i class="fas fa-search me-2"></i>
                                {% trans "Search with AI" %}
                            </button>
                        </div>
                    </div>

                    <div class="example-text">
                        <strong>{% trans "Examples:" %}</strong><br>
                        ‚Ä¢ "{% trans "Kaffeemaschine f√ºr Espresso mit Milchaufsch√§umer" %}"<br>
                        ‚Ä¢ "{% trans "Mountainbike f√ºr schwierige Trails" %}"<br>
                        ‚Ä¢ "{% trans "Laptop for programming and development work" %}"
                    </div>
                </form>
            </div>

            <!-- Results -->
            {% if search_query %}
                <!-- Existing Search Notice -->
                {% if existing_search %}
                <div class="alert alert-warning d-flex align-items-center mb-3">
                    <i class="fas fa-info-circle me-3 fa-2x"></i>
                    <div>
                        <strong>{% trans "Search in Progress" %}</strong><br>
                        <small>{% trans "You already have an active search running. Showing progress for:" %} "<strong>{{ search_query }}</strong>"</small>
                    </div>
                </div>
                {% endif %}

                <!-- Search Processing Status -->
                <div id="search-processing" class="alert alert-info d-flex align-items-center" style="display: none;">
                    <div class="spinner-border spinner-border-sm me-3" role="status">
                        <span class="visually-hidden">{% trans "Loading..." %}</span>
                    </div>
                    <div>
                        <strong>{% trans "üîç AI Search in Progress..." %}</strong><br>
                        <small>{% trans "Analyzing your query and finding similar items. This may take a few seconds." %}</small>
                    </div>
                </div>

                <!-- Search Completed Notification -->
                <div id="search-completed" class="alert alert-success d-none">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{% trans "‚úÖ Search Complete!" %}</strong><br>
                            <small id="results-summary">{% trans "Found results for your query." %}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-success" onclick="showSearchResults()">
                            {% trans "View Results" %}
                        </button>
                    </div>
                </div>

                <!-- Search Failed -->
                <div id="search-failed" class="alert alert-danger d-none">
                    <strong>{% trans "‚ùå Search Failed" %}</strong><br>
                    <small id="error-message">{% trans "Something went wrong with your search. Please try again." %}</small>
                </div>

                <!-- Results Container -->
                <div id="results-container" class="d-none">
                    <div class="results-header">
                        <div class="ai-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div>
                            <h3 class="mb-1">{% trans "AI Found These Similar Items" %}</h3>
                            <p class="text-muted mb-0">
                                {% trans "Showing results for" %}: "<strong>{{ search_query }}</strong>"
                            </p>
                        </div>
                    </div>

                    <div id="results-grid" class="row">
                        <!-- Results will be populated via AJAX -->
                    </div>

                    <!-- Info Box -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>{% trans "How it works:" %}</strong>
                        {% trans "Our AI analyzes your search query and compares it with item descriptions, names, and categories to find the most relevant matches." %}
                    </div>
                </div>

                <!-- No Results -->
                <div id="no-results" class="no-results d-none">
                    <i class="fas fa-search fa-4x"></i>
                    <h3>{% trans "No Similar Items Found" %}</h3>
                    <p class="text-muted mb-3">
                        {% trans "We couldn't find any items similar to" %} "<strong>{{ search_query }}</strong>".
                    </p>
                    <div class="alert alert-warning d-inline-block">
                        <strong>{% trans "Tips:" %}</strong><br>
                        ‚Ä¢ {% trans "Try using different keywords" %}<br>
                        ‚Ä¢ {% trans "Use more general terms" %}<br>
                        ‚Ä¢ {% trans "Try searching in German or English" %}
                    </div>
                </div>
            {% else %}
                <div class="no-results">
                    <i class="fas fa-brain fa-4x"></i>
                    <h3>{% trans "Start Your AI Search" %}</h3>
                    <p class="text-muted">
                        {% trans "Enter a description of what you're looking for in the search box above." %}
                    </p>
                </div>
            {% endif %}

            <!-- Back Link -->
            <a href="{% url 'items:list' %}" class="back-link">
                <i class="fas fa-arrow-left"></i>
                {% trans "Back to All Items" %}
            </a>
        </div>
    </div>
</div>

<script>
// Search status polling for async search
{% if search_id %}
const searchId = '{{ search_id }}';
let pollInterval;

// Start polling for search status
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded fired, searchId:', searchId);
    const processingDiv = document.getElementById('search-processing');
    console.log('Processing div found:', processingDiv);

    if (searchId) {
        console.log('Starting search status polling for:', searchId);
        // Show processing message initially
        processingDiv.style.display = 'block';
        console.log('Processing message shown');
        // Start polling immediately, but ensure users see the processing state
        startSearchStatusPolling();
    } else {
        console.log('No searchId found, skipping polling');
    }
});

function startSearchStatusPolling() {
    pollInterval = setInterval(checkSearchStatus, 1000); // Check every 1 second
    checkSearchStatus(); // Initial check
}

function stopSearchStatusPolling() {
    if (pollInterval) {
        console.log('Stopping search status polling'); // Debug log
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

async function checkSearchStatus() {
    try {
        console.log('Checking search status for ID:', searchId); // Debug log
        const response = await fetch(`/items/search-status/${searchId}/`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Search status response:', data); // Debug log

        if (data.status === 'success') {
            updateSearchUI(data);

            if (data.is_completed || data.has_failed) {
                console.log('Search finished, stopping polling'); // Debug log
                stopSearchStatusPolling();
            }
        } else {
            console.error('Error checking search status:', data.message);
        }
    } catch (error) {
        console.error('Error checking search status:', error);
        // Don't stop polling on network errors, just log them
    }
}

function updateSearchUI(data) {
    const processingDiv = document.getElementById('search-processing');
    const completedDiv = document.getElementById('search-completed');
    const failedDiv = document.getElementById('search-failed');

    console.log('=== updateSearchUI called ===');
    console.log('Data received:', data);
    console.log('Processing div:', processingDiv);
    console.log('Current processing div display:', processingDiv ? processingDiv.style.display : 'null');

    // Hide completed and failed divs first
    if (completedDiv) {
        completedDiv.classList.add('d-none');
        console.log('Completed div hidden');
    }
    if (failedDiv) {
        failedDiv.classList.add('d-none');
        console.log('Failed div hidden');
    }

    if (data.is_processing) {
        console.log('Search is processing...'); // Debug log
        // Keep processing div visible (don't hide it)
        if (processingDiv && processingDiv.style.display !== 'block') {
            processingDiv.style.display = 'block';
            console.log('Processing div shown');
        }
    } else if (data.is_completed) {
        console.log('Search completed with', data.results_count, 'results'); // Debug log

        // Hide the processing message
        if (processingDiv) {
            processingDiv.style.display = 'none';
            processingDiv.style.visibility = 'hidden';
            processingDiv.classList.add('d-none');
            console.log('Processing div hidden - search completed');
            console.log('Processing div after hiding:', processingDiv.style.display, processingDiv.style.visibility);
        }

        // Also check if there are multiple elements with the same ID
        const allProcessingDivs = document.querySelectorAll('#search-processing');
        console.log('Found', allProcessingDivs.length, 'processing divs');
        allProcessingDivs.forEach((div, index) => {
            div.style.display = 'none';
            div.style.visibility = 'hidden';
            div.classList.add('d-none');
            console.log(`Processing div ${index} hidden forcefully`);
        });

        // Update results summary
        const summaryElement = document.getElementById('results-summary');
        if (data.results_count > 0) {
            summaryElement.textContent = `{% trans "Found" %} ${data.results_count} {% trans "similar items" %}`;
            completedDiv.classList.remove('d-none');
            // Auto-show results after a short delay
            setTimeout(() => {
                showSearchResults();
            }, 1000);
        } else {
            summaryElement.textContent = `{% trans "No similar items found" %}`;
            // Show no results message directly
            const noResultsDiv = document.getElementById('no-results');
            noResultsDiv.classList.remove('d-none');
        }
    } else if (data.has_failed) {
        console.log('Search failed:', data.error_message); // Debug log
        failedDiv.classList.remove('d-none');

        // Update error message
        const errorElement = document.getElementById('error-message');
        errorElement.textContent = data.error_message || '{% trans "Search failed. Please try again." %}';
    }
}

async function showSearchResults() {
    try {
        const response = await fetch(`/items/search-results/${searchId}/`);
        const data = await response.json();

        if (data.status === 'success') {
            displaySearchResults(data.results);
        } else {
            console.error('Error loading search results:', data.message);
        }
    } catch (error) {
        console.error('Error loading search results:', error);
    }
}

function displaySearchResults(results) {
    const processingDiv = document.getElementById('search-processing');
    const completedDiv = document.getElementById('search-completed');
    const resultsContainer = document.getElementById('results-container');
    const noResultsDiv = document.getElementById('no-results');
    const resultsGrid = document.getElementById('results-grid');

    console.log('=== displaySearchResults called ===');
    console.log('Results:', results);
    console.log('Processing div:', processingDiv);
    console.log('Current processing div display:', processingDiv ? processingDiv.style.display : 'null');

    // Hide processing message and notification
    if (processingDiv) {
        processingDiv.style.display = 'none';
        processingDiv.style.visibility = 'hidden';
        processingDiv.classList.add('d-none');
        console.log('Processing div hidden in displaySearchResults');
    }

    // Also force hide all processing divs
    const allProcessingDivs = document.querySelectorAll('#search-processing');
    allProcessingDivs.forEach((div, index) => {
        div.style.display = 'none';
        div.style.visibility = 'hidden';
        div.classList.add('d-none');
        console.log(`Force hiding processing div ${index} in displaySearchResults`);
    });
    if (completedDiv) {
        completedDiv.classList.add('d-none');
        console.log('Completed div hidden in displaySearchResults');
    }

    if (results && results.length > 0) {
        // Clear existing results
        resultsGrid.innerHTML = '';

        // Populate with new results
        results.forEach(item => {
            const itemHtml = createItemCard(item);
            resultsGrid.insertAdjacentHTML('beforeend', itemHtml);
        });

        // Show results container
        resultsContainer.classList.remove('d-none');
        noResultsDiv.classList.add('d-none');
    } else {
        // Show no results
        resultsContainer.classList.add('d-none');
        noResultsDiv.classList.remove('d-none');
    }
}

function createItemCard(item) {
    // Create a simplified item card HTML
    return `
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="card h-100 shadow-sm">
                <div class="position-relative">
                    ${item.image_url ? `<img src="${item.image_url}" class="card-img-top" alt="${item.name}" style="height: 200px; object-fit: cover;">` : '<div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;"><i class="fas fa-image fa-3x text-muted"></i></div>'}
                    <div class="distance-badge position-absolute top-0 end-0 m-2">
                        <i class="fas fa-chart-line me-1"></i>
                        {% trans "Match" %}: ${(item.similarity * 100).toFixed(1)}%
                    </div>
                </div>
                <div class="card-body">
                    <h5 class="card-title">${item.name}</h5>
                    <p class="card-text text-muted small">${item.description ? item.description.substring(0, 100) + '...' : ''}</p>
                    ${item.price ? `<p class="card-text"><strong>‚Ç¨${item.price}</strong></p>` : ''}
                    <a href="/items/${item.id}/" class="btn btn-primary btn-sm">{% trans "View Details" %}</a>
                </div>
            </div>
        </div>
    `;
}
{% endif %}
</script>
{% endblock %}
