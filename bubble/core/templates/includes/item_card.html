{% load i18n static item_extras %}

<style>
  .item-image-fixed-height {
    height: 200px;
    object-fit: cover;
  }
</style>
<div class="card item-card h-100">
  <div class="item-image">
    {% with first_image=item.get_first_image %}
      {% if first_image %}
        <img src="{{ first_image.original.url }}"
             class="card-img-top item-image-fixed-height"
             alt="{{ item.name }}" />
      {% elif item.images.all|length > 0 %}
        {# Fallback for prefetched images #}
        <img src="{{ item.images.all.0.original.url }}"
             class="card-img-top item-image-fixed-height"
             alt="{{ item.name }}" />
      {% else %}
        <div class="card-img-top bg-light d-flex align-items-center justify-content-center item-image-fixed-height">
          <i class="fas fa-image fa-3x text-muted"></i>
        </div>
      {% endif %}
    {% endwith %}
    <!-- Dynamic Upper Tag -->
    {% if item.category.get_root_category.upper_tag and item.custom_fields %}
      {% with upper_field=item.category.get_root_category.upper_tag %}
        {% if item.custom_fields|get_item:upper_field %}
          {% with field_value=item.custom_fields|get_item:upper_field|get_item:"value" %}
            {% with field_type=item.category|get_field_type:upper_field %}
              <div class="item-type-badge">
                {% if field_type == "choice" %}
                  <span class="badge" style="background-color: {{ field_value|get_badge_color }};">{{ field_value }}</span>
                {% else %}
                  <span class="badge bg-primary">{{ field_value }}</span>
                {% endif %}
              </div>
            {% endwith %}
          {% endwith %}
        {% endif %}
      {% endwith %}
    {% endif %}
    <!-- Dynamic Lower Tag -->
    {% if item.category.get_root_category.lower_tag and item.custom_fields %}
      {% with lower_field=item.category.get_root_category.lower_tag %}
        {% if item.custom_fields|get_item:lower_field %}
          {% with field_value=item.custom_fields|get_item:lower_field|get_item:"value" %}
            {% with field_type=item.category|get_field_type:lower_field %}
              {% if field_type == "choice" %}
                <div class="price-tag choice-tag" style="background-color: {{ field_value|get_badge_color }};">
                  {{ field_value }}
                </div>
              {% else %}
                <div class="price-tag">
                  {{ field_value }}
                  {% if item.category.get_root_category.lower_tag == "price" %}â‚¬{% endif %}
                </div>
              {% endif %}
            {% endwith %}
          {% endwith %}
        {% endif %}
      {% endwith %}
    {% endif %}
  </div>
  <div class="card-body">
    <h5 class="card-title mb-2">{{ item.name }}</h5>
    <div class="d-flex justify-content-between align-items-center">
      <small class="text-muted">
        <i class="fas fa-folder"></i> {{ item.category|hierarchy_without_root }}
      </small>
      <small class="text-muted">
        <i class="fas fa-calendar"></i> {{ item.date_created|date:"M d" }}
      </small>
    </div>
  </div>
  <div class="card-footer bg-transparent">
    <div class="d-flex justify-content-between align-items-center">
      <small class="text-muted">
        <i class="fas fa-user"></i> {{ item.user.username }}
        {% if item.user.name %}({{ item.user.name }}){% endif %}
      </small>
      <a href="{% if content_type_slug %}{% url 'items:detail' content_type=content_type_slug pk=item.pk %}{% else %}{% url 'items:detail' item.pk %}{% endif %}"
         class="btn btn-outline-primary btn-sm">
        <i class="fas fa-eye"></i> {% trans "View" %}
      </a>
    </div>
  </div>
</div>
